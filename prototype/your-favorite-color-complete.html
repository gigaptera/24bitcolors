<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Favorite Color - è‰²ã®å¥½ã¿è¨ºæ–­</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            max-width: 400px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
        }
        
        .app-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .logo {
            font-size: 24px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            font-size: 14px;
            margin-bottom: 30px;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .question-count {
            font-size: 12px;
            color: #999;
            margin-bottom: 20px;
        }
        
        .question-text {
            font-size: 18px;
            font-weight: 500;
            color: #333;
            margin-bottom: 30px;
        }
        
        .color-comparison {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }
        
        .color-option {
            flex: 1;
            height: 120px;
            border-radius: 15px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .color-option:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .color-option:active {
            transform: scale(0.98);
        }
        
        .color-label {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.9);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
            color: #333;
        }
        
        .start-screen, .result-screen {
            text-align: center;
        }
        
        .start-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .start-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .result-color {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin: 20px auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .result-hex {
            font-family: 'Courier New', monospace;
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin: 10px 0;
        }
        
        .confidence {
            color: #28a745;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 20px;
        }
        
        .share-button {
            background: #1da1f2;
            color: white;
            border: none;
            padding: 10px 30px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            margin: 5px;
        }
        
        .hidden {
            display: none;
        }
        
        .prediction {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-size: 14px;
            color: #666;
        }
        
        .prediction-color {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-block;
            vertical-align: middle;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="app-card">
            <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
            <div id="startScreen" class="start-screen">
                <div class="logo">ğŸ¨ Your Favorite Color</div>
                <div class="subtitle">20ã®è³ªå•ã§ã‚ãªãŸã®å¥½ããªè‰²ã‚’ç‰¹å®šã—ã¾ã™</div>
                <p style="margin: 20px 0; color: #666; font-size: 14px;">
                    bitè¨ºæ–­æ–¹å¼ã§1677ä¸‡è‰²ã®ä¸­ã‹ã‚‰<br>
                    ã‚ãªãŸã®çœŸã®å¥½ã¿ã‚’è¦‹ã¤ã‘å‡ºã—ã¾ã™
                </p>
                <button class="start-button" onclick="startDiagnosis()">
                    è¨ºæ–­ã‚’é–‹å§‹ã™ã‚‹
                </button>
            </div>
            
            <!-- è³ªå•ç”»é¢ -->
            <div id="questionScreen" class="hidden">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="question-count" id="questionCount">è³ªå• 1 / 20</div>
                <div class="question-text">ã©ã¡ã‚‰ã®è‰²ãŒãŠå¥½ã¿ã§ã™ã‹ï¼Ÿ</div>
                
                <div class="color-comparison">
                    <button class="color-option" id="colorA" onclick="selectColor('A')">
                        <div class="color-label" id="labelA">è‰²A</div>
                    </button>
                    <button class="color-option" id="colorB" onclick="selectColor('B')">
                        <div class="color-label" id="labelB">è‰²B</div>
                    </button>
                </div>
                
                <div class="prediction" id="prediction">
                    <div class="prediction-color" id="predictionColor"></div>
                    <span id="predictionText">åˆ†æä¸­...</span>
                </div>
            </div>
            
            <!-- çµæœç”»é¢ -->
            <div id="resultScreen" class="hidden">
                <div class="logo">ğŸ¯ è¨ºæ–­å®Œäº†ï¼</div>
                <div class="result-color" id="finalColor"></div>
                <div class="result-hex" id="finalHex">#FF6B9D</div>
                <div class="confidence">çš„ä¸­ç‡: <span id="confidenceScore">95</span>%</div>
                <p style="margin: 15px 0; color: #666;">
                    ã“ã®è‰²ãŒã‚ãªãŸã®å¥½ã¿ã§ã™ï¼<br>
                    çµ±è¨ˆçš„åˆ†æã«ã‚ˆã‚Šç®—å‡ºã•ã‚Œã¾ã—ãŸã€‚
                </p>
                <button class="share-button" onclick="shareResult()">
                    ğŸ¦ çµæœã‚’ã‚·ã‚§ã‚¢
                </button>
                <button class="share-button" onclick="restartDiagnosis()" style="background: #6c757d;">
                    ğŸ”„ ã‚‚ã†ä¸€åº¦è¨ºæ–­
                </button>
            </div>
        </div>
    </div>

    <script>
// è‰²ã®å¥½ã¿è¨ºæ–­ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
class ColorPreferenceDiagnosis {
    constructor() {
        this.currentQuestion = 0;
        this.totalQuestions = 20;
        this.userChoices = [];
        this.colorSpace = this.initializeColorSpace();
        this.currentPrediction = null;
    }
    
    // åˆæœŸè‰²ç©ºé–“ã‚’å®šç¾© (OKLCHç©ºé–“ã‚’ç°¡ç•¥åŒ–)
    initializeColorSpace() {
        const colors = [];
        
        // è‰²ç›¸ (Hue): 0-360åº¦ã‚’24åˆ†å‰²
        // æ˜åº¦ (Lightness): 0.2-0.9ã‚’4åˆ†å‰²  
        // å½©åº¦ (Chroma): 0.05-0.25ã‚’4åˆ†å‰²
        
        for (let h = 0; h < 360; h += 15) {
            for (let l = 0.3; l <= 0.8; l += 0.25) {
                for (let c = 0.08; c <= 0.2; c += 0.06) {
                    colors.push({
                        hue: h,
                        lightness: l,
                        chroma: c,
                        weight: 1.0
                    });
                }
            }
        }
        
        return colors;
    }
    
    // OKLCH to RGB å¤‰æ› (ç°¡ç•¥ç‰ˆ)
    oklchToRgb(l, c, h) {
        // ç°¡ç•¥åŒ–ã•ã‚ŒãŸå¤‰æ›å¼ (å®Ÿç”¨çš„ãªè¿‘ä¼¼)
        const hueRad = (h * Math.PI) / 180;
        const a = c * Math.cos(hueRad);
        const b = c * Math.sin(hueRad);
        
        // Lab to RGB ã®ç°¡ç•¥å¤‰æ›
        const y = (l + 0.16) / 1.16;
        const x = y + (a / 500);
        const z = y - (b / 200);
        
        // XYZ to RGB (sRGBè¿‘ä¼¼)
        let r = x * 3.2406 + y * -1.5372 + z * -0.4986;
        let g = x * -0.9689 + y * 1.8758 + z * 0.0415;
        let blue = x * 0.0557 + y * -0.2040 + z * 1.0570;
        
        // ã‚¬ãƒ³ãƒè£œæ­£ã¨ã‚¯ãƒ©ãƒ³ãƒ—
        r = Math.max(0, Math.min(1, r));
        g = Math.max(0, Math.min(1, g));
        blue = Math.max(0, Math.min(1, blue));
        
        return {
            r: Math.round(r * 255),
            g: Math.round(g * 255),
            b: Math.round(blue * 255)
        };
    }
    
    // RGB to HEX
    rgbToHex(r, g, b) {
        return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
    }
    
    // è‰²ã‚’HEXå½¢å¼ã§å–å¾—
    getColorHex(colorData) {
        const rgb = this.oklchToRgb(colorData.lightness, colorData.chroma, colorData.hue);
        return this.rgbToHex(rgb.r, rgb.g, rgb.b);
    }
    
    // æœ€é©ãª2è‰²ã‚’é¸æŠ (æƒ…å ±é‡æœ€å¤§åŒ–)
    selectOptimalColorPair() {
        const validColors = this.colorSpace.filter(c => c.weight > 0);
        
        if (validColors.length < 2) {
            return [validColors[0], validColors[0]];
        }
        
        // è‰²ç©ºé–“ã‚’æœ€ã‚‚åŠ¹ç‡çš„ã«äºŒåˆ†ã™ã‚‹2è‰²ã‚’é¸æŠ
        // ç°¡ç•¥åŒ–: ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠ + è·é›¢ãŒé›¢ã‚ŒãŸè‰²ã‚’å„ªå…ˆ
        const shuffled = [...validColors].sort(() => Math.random() - 0.5);
        
        let bestPair = [shuffled[0], shuffled[1]];
        let maxDistance = 0;
        
        for (let i = 0; i < Math.min(20, shuffled.length); i++) {
            for (let j = i + 1; j < Math.min(20, shuffled.length); j++) {
                const colorA = shuffled[i];
                const colorB = shuffled[j];
                
                // è‰²ç©ºé–“ã§ã®è·é›¢è¨ˆç®—
                const distance = Math.sqrt(
                    Math.pow((colorA.hue - colorB.hue) / 360, 2) +
                    Math.pow((colorA.lightness - colorB.lightness), 2) +
                    Math.pow((colorA.chroma - colorB.chroma) * 4, 2)
                );
                
                if (distance > maxDistance) {
                    maxDistance = distance;
                    bestPair = [colorA, colorB];
                }
            }
        }
        
        return bestPair;
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é¸æŠã‚’å‡¦ç†
    processChoice(choice, colorA, colorB) {
        this.userChoices.push({ choice, colorA, colorB });
        
        // é¸æŠã•ã‚Œãªã‹ã£ãŸè‰²ã®é‡ã¿ã‚’æ¸›ã‚‰ã™
        const selectedColor = choice === 'A' ? colorA : colorB;
        const rejectedColor = choice === 'A' ? colorB : colorA;
        
        this.colorSpace.forEach(color => {
            // é¸æŠã•ã‚ŒãŸè‰²ã«è¿‘ã„è‰²ã®é‡ã¿ã‚’å¢—åŠ 
            const distanceToSelected = this.getColorDistance(color, selectedColor);
            const distanceToRejected = this.getColorDistance(color, rejectedColor);
            
            if (distanceToSelected < distanceToRejected) {
                color.weight *= 1.2; // é‡ã¿ã‚’å¢—åŠ 
            } else {
                color.weight *= 0.7; // é‡ã¿ã‚’æ¸›å°‘
            }
        });
        
        // é‡ã¿ã‚’æ­£è¦åŒ–
        const totalWeight = this.colorSpace.reduce((sum, c) => sum + c.weight, 0);
        this.colorSpace.forEach(c => c.weight /= totalWeight);
        
        this.currentQuestion++;
        this.updatePrediction();
    }
    
    // è‰²é–“ã®è·é›¢è¨ˆç®—
    getColorDistance(colorA, colorB) {
        return Math.sqrt(
            Math.pow((colorA.hue - colorB.hue) / 360, 2) +
            Math.pow((colorA.lightness - colorB.lightness), 2) +
            Math.pow((colorA.chroma - colorB.chroma) * 4, 2)
        );
    }
    
    // ç¾åœ¨ã®äºˆæ¸¬è‰²ã‚’æ›´æ–°
    updatePrediction() {
        // é‡ã¿ä»˜ãå¹³å‡ã§ç¾åœ¨ã®äºˆæ¸¬ã‚’è¨ˆç®—
        let totalWeight = 0;
        let avgHue = 0;
        let avgLightness = 0;
        let avgChroma = 0;
        
        // å††å½¢åº§æ¨™ã§ã®å¹³å‡è¨ˆç®— (è‰²ç›¸)
        let sinSum = 0, cosSum = 0;
        
        this.colorSpace.forEach(color => {
            if (color.weight > 0.001) { // é–¾å€¤ä»¥ä¸‹ã¯ç„¡è¦–
                const hueRad = (color.hue * Math.PI) / 180;
                sinSum += Math.sin(hueRad) * color.weight;
                cosSum += Math.cos(hueRad) * color.weight;
                
                avgLightness += color.lightness * color.weight;
                avgChroma += color.chroma * color.weight;
                totalWeight += color.weight;
            }
        });
        
        if (totalWeight > 0) {
            avgHue = (Math.atan2(sinSum, cosSum) * 180) / Math.PI;
            if (avgHue < 0) avgHue += 360;
            
            avgLightness /= totalWeight;
            avgChroma /= totalWeight;
            
            this.currentPrediction = {
                hue: avgHue,
                lightness: avgLightness,
                chroma: avgChroma,
                confidence: Math.min(95, 50 + this.currentQuestion * 2.2)
            };
        }
    }
    
    // æœ€çµ‚çµæœã‚’å–å¾—
    getFinalResult() {
        // æœ€ã‚‚é‡ã¿ã®é«˜ã„è‰²ã‚’é¸æŠ
        const topColors = this.colorSpace
            .filter(c => c.weight > 0)
            .sort((a, b) => b.weight - a.weight)
            .slice(0, 5);
        
        if (topColors.length === 0) {
            return this.currentPrediction;
        }
        
        // ãƒˆãƒƒãƒ—5ã®åŠ é‡å¹³å‡
        let totalWeight = 0;
        let avgHue = 0;
        let avgLightness = 0;
        let avgChroma = 0;
        
        let sinSum = 0, cosSum = 0;
        
        topColors.forEach(color => {
            const hueRad = (color.hue * Math.PI) / 180;
            sinSum += Math.sin(hueRad) * color.weight;
            cosSum += Math.cos(hueRad) * color.weight;
            
            avgLightness += color.lightness * color.weight;
            avgChroma += color.chroma * color.weight;
            totalWeight += color.weight;
        });
        
        avgHue = (Math.atan2(sinSum, cosSum) * 180) / Math.PI;
        if (avgHue < 0) avgHue += 360;
        
        return {
            hue: avgHue,
            lightness: avgLightness / totalWeight,
            chroma: avgChroma / totalWeight,
            confidence: Math.min(98, 70 + this.currentQuestion * 1.4)
        };
    }
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let diagnosis = null;

// è¨ºæ–­é–‹å§‹
function startDiagnosis() {
    diagnosis = new ColorPreferenceDiagnosis();
    
    document.getElementById('startScreen').classList.add('hidden');
    document.getElementById('questionScreen').classList.remove('hidden');
    
    showNextQuestion();
}

// æ¬¡ã®è³ªå•ã‚’è¡¨ç¤º
function showNextQuestion() {
    if (diagnosis.currentQuestion >= diagnosis.totalQuestions) {
        showResult();
        return;
    }
    
    const [colorA, colorB] = diagnosis.selectOptimalColorPair();
    
    // UIæ›´æ–°
    const progress = (diagnosis.currentQuestion / diagnosis.totalQuestions) * 100;
    document.getElementById('progressFill').style.width = progress + '%';
    document.getElementById('questionCount').textContent = 
        `è³ªå• ${diagnosis.currentQuestion + 1} / ${diagnosis.totalQuestions}`;
    
    // è‰²ã‚’è¨­å®š
    const hexA = diagnosis.getColorHex(colorA);
    const hexB = diagnosis.getColorHex(colorB);
    
    document.getElementById('colorA').style.backgroundColor = hexA;
    document.getElementById('colorB').style.backgroundColor = hexB;
    document.getElementById('labelA').textContent = hexA;
    document.getElementById('labelB').textContent = hexB;
    
    // ç¾åœ¨ã®äºˆæ¸¬ã‚’è¡¨ç¤º
    if (diagnosis.currentPrediction) {
        const predHex = diagnosis.getColorHex(diagnosis.currentPrediction);
        document.getElementById('predictionColor').style.backgroundColor = predHex;
        document.getElementById('predictionText').textContent = 
            `ç¾åœ¨ã®äºˆæƒ³: ${predHex} (ä¿¡é ¼åº¦: ${Math.round(diagnosis.currentPrediction.confidence)}%)`;
    }
    
    // é¸æŠè‚¢ã‚’ä¿å­˜
    window.currentColorA = colorA;
    window.currentColorB = colorB;
}

// è‰²ã‚’é¸æŠ
function selectColor(choice) {
    diagnosis.processChoice(choice, window.currentColorA, window.currentColorB);
    
    // ã¡ã‚‡ã£ã¨ã—ãŸæ¼”å‡º
    setTimeout(() => {
        showNextQuestion();
    }, 300);
}

// çµæœç”»é¢ã‚’è¡¨ç¤º
function showResult() {
    document.getElementById('questionScreen').classList.add('hidden');
    document.getElementById('resultScreen').classList.remove('hidden');
    
    const result = diagnosis.getFinalResult();
    const finalHex = diagnosis.getColorHex(result);
    
    document.getElementById('finalColor').style.backgroundColor = finalHex;
    document.getElementById('finalHex').textContent = finalHex;
    document.getElementById('confidenceScore').textContent = Math.round(result.confidence);
}

// çµæœã‚’ã‚·ã‚§ã‚¢
function shareResult() {
    const hex = document.getElementById('finalHex').textContent;
    const confidence = document.getElementById('confidenceScore').textContent;
    const text = `ç§ã®å¥½ããªè‰²ã¯ ${hex} ã§ã™ï¼ (çš„ä¸­ç‡: ${confidence}%) #YourFavoriteColor`;
    
    if (navigator.share) {
        navigator.share({ text });
    } else {
        navigator.clipboard.writeText(text).then(() => {
            alert('çµæœã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
        });
    }
}

// è¨ºæ–­ã‚’å†é–‹å§‹
function restartDiagnosis() {
    document.getElementById('resultScreen').classList.add('hidden');
    document.getElementById('startScreen').classList.remove('hidden');
}    </script>
</body>
</html>
